/**
 * 移动端视觉断层修复样式
 * 解决ChainEditor在移动设备上的渲染断层问题
 */

/**
 * 移动端视觉断层修复样式
 * 解决ChainEditor在移动设备上的渲染断层问题
 * 优化GPU加速策略，减少不必要的合成层
 */

/* 智能GPU加速：只为必要元素启用 */
@media (max-width: 768px) {
  /* 主容器：仅在必要时启用GPU加速 */
  .chain-editor-container {
    /* 使用contain代替will-change，减少内存占用 */
    contain: layout;
    /* 只在有动画时才启用GPU加速 */
    transform: none;
  }

  /* 卡片元素：去除过度GPU加速 */
  .bento-card {
    /* 使用isolation保证层叠，但不创建合成层 */
    isolation: isolate;
    /* 移除不必要的transform */
    transform: none;
    will-change: auto;
    /* 使用contain优化渲染 */
    contain: layout style;
  }

  /* 设置区域：轻量化GPU使用 */
  .setting-section {
    contain: layout;
    isolation: isolate;
    transform: none;
  }

  /* 表单容器：只保留必要的优化 */
  form {
    contain: layout;
    isolation: isolate;
    transform: none;
  }

  /* 响应式容器：优化滚动性能 */
  .responsive-container {
    contain: layout;
    overflow-x: hidden;
    isolation: isolate;
    transform: none;
  }
}

/* 动画优化 - 只在必要时使用GPU加速 */
@media (max-width: 768px) {
  /* 优化淡入动画 */
  .animate-fade-in {
    animation: mobileFadeIn 0.4s ease-out forwards;
    /* 只在动画期间启用GPU加速 */
    will-change: opacity;
  }

  /* 优化滑入动画 */
  .animate-slide-up {
    animation: mobileSlideUp 0.5s ease-out forwards;
    will-change: opacity, transform;
  }

  /* 优化缩放动画 */
  .animate-scale-in {
    animation: mobileScaleIn 0.3s ease-out forwards;
    will-change: opacity, transform;
  }

  /* 动画结束后清除GPU加速 */
  .animate-fade-in.animation-complete,
  .animate-slide-up.animation-complete,
  .animate-scale-in.animation-complete {
    will-change: auto;
  }

  /* 简化hover效果，避免不必要的重绘 */
  .bento-card:hover {
    /* 只使用box-shadow和border变化 */
    box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
  }

  /* 简化transition效果 */
  .bento-card {
    transition: box-shadow 0.2s ease, border-color 0.2s ease !important;
  }
}

/* 移动端专用动画关键帧 - 优化GPU使用 */
@keyframes mobileFadeIn {
  from {
    opacity: 0;
    /* 减少transform使用 */
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes mobileSlideUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes mobileScaleIn {
  from {
    opacity: 0;
    transform: scale(0.95);
  }
  to {
    opacity: 1;
    transform: scale(1);
  }
}

/* 滚动优化 - 保证滚动性能优先 */
@media (max-width: 768px) {
  /* 基础滚动优化 */
  html, body {
    -webkit-overflow-scrolling: touch;
    scroll-behavior: smooth;
    overscroll-behavior: contain;
  }

  /* ChainEditor专用滚动优化 */
  .chain-editor-scroll-container {
    -webkit-overflow-scrolling: touch;
    overflow-y: auto;
    overflow-x: hidden;
    /* 优先保证滚动性能 */
    contain: size layout;
    /* 只在必要时启用GPU */
    transform: none;
  }

  /* 输入框聚焦时的优化 */
  input:focus,
  textarea:focus,
  select:focus {
    /* 减少不必要的GPU加速 */
    backface-visibility: visible;
    transform: none;
  }
}

/* 虚拟键盘适配优化 */
@media (max-width: 768px) {
  /* 键盘出现时的布局稳定性 */
  .keyboard-active .chain-editor-container {
    position: relative;
    min-height: 100vh;
    padding-bottom: env(keyboard-inset-height, 0px);
  }

  /* 防止键盘引起的重排 */
  .keyboard-active form {
    contain: layout style;
    isolation: isolate;
  }

  /* 键盘区域的缓冲 */
  .keyboard-buffer {
    height: env(keyboard-inset-height, 0px);
    min-height: 0;
    flex-shrink: 0;
  }
}

/* 内存和性能优化 */
@media (max-width: 768px) {
  /* 减少重绘区域但保持滚动 */
  .performance-layer {
    contain: layout style;
    isolation: isolate;
    transform: translateZ(0);
    -webkit-transform: translateZ(0);
  }

  /* 优化阴影渲染 */
  .bento-card {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1) !important;
  }

  .dark .bento-card {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3) !important;
  }

  /* 减少backdrop-blur的使用 */
  .bento-card {
    backdrop-filter: none !important;
    -webkit-backdrop-filter: none !important;
  }
}

/* 特定设备优化 */
@media (max-width: 480px) {
  /* 小屏设备的额外优化 */
  .chain-editor-container {
    contain: layout;
  }

  /* 进一步简化动画 */
  .animate-fade-in,
  .animate-slide-up,
  .animate-scale-in {
    animation-duration: 0.2s !important;
  }

  /* 减少变换操作 */
  .bento-card:hover,
  .bento-card:focus {
    transform: none !important;
    -webkit-transform: none !important;
  }
}

/* iOS Safari特定修复 */
@supports (-webkit-touch-callout: none) {
  @media (max-width: 768px) {
    /* Safari的渲染优化 */
    .chain-editor-container {
      -webkit-transform: translate3d(0, 0, 0);
      transform: translate3d(0, 0, 0);
      /* 使用CSS变量修复100vh问题 */
      min-height: calc(var(--vh, 1vh) * 100);
    }

    /* 优化Safari滚动但保持滚动功能 */
    body {
      overflow-x: hidden;
      width: 100%;
      min-height: calc(var(--vh, 1vh) * 100);
      -webkit-overflow-scrolling: touch;
      overscroll-behavior: contain;
    }

    .chain-editor-scroll-container {
      overflow-y: auto;
      overflow-x: hidden;
      -webkit-overflow-scrolling: touch;
      min-height: calc(var(--vh, 1vh) * 100);
      overscroll-behavior: contain;
    }

    /* 修复Safari的输入框缩放 */
    input[type="text"],
    input[type="number"],
    input[type="email"],
    textarea,
    select {
      font-size: 16px !important;
      transform: translateZ(0);
      -webkit-transform: translateZ(0);
    }
  }
}

/* 高DPI屏幕优化 */
@media (max-width: 768px) and (-webkit-min-device-pixel-ratio: 2) {
  /* 高分辨率屏幕的渲染优化 */
  .bento-card {
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
  }

  /* 边框渲染优化 */
  .bento-card {
    border-width: 0.5px;
  }
}

/* 低端设备优化 */
@media (max-width: 768px) and (prefers-reduced-motion: reduce) {
  /* 完全禁用动画和变换 */
  * {
    animation: none !important;
    transition: none !important;
    transform: none !important;
    -webkit-transform: none !important;
  }

  /* 简化视觉效果 */
  .bento-card {
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1) !important;
    border-radius: 8px !important;
  }
}